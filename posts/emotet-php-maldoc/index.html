<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Emotet infection from PHP: generation of a malicious doc | andpalmier</title>
<meta name="keywords" content="malware, emotet, threat analysis">
<meta name="description" content="Analysis of a PHP file used to generate a document containing malicious macros for Emotet infection">
<meta name="author" content="">
<link rel="canonical" href="https://andpalmier.com/posts/emotet-php-maldoc/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.385652845d5bf34ec58b4ee7474842d3066fb85201eb3ac4ccf922cfac99eb2b.css" integrity="sha256-OFZShF1b807Fi07nR0hC0wZvuFIB6zrEzPkiz6yZ6ys=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://andpalmier.com/images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://andpalmier.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://andpalmier.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://andpalmier.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://andpalmier.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://andpalmier.com/posts/emotet-php-maldoc/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="Emotet infection from PHP: generation of a malicious doc" />
<meta property="og:description" content="Analysis of a PHP file used to generate a document containing malicious macros for Emotet infection" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://andpalmier.com/posts/emotet-php-maldoc/" /><meta property="og:image" content="https://andpalmier.com/papermod-cover.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-12T10:33:45+02:00" />
<meta property="article:modified_time" content="2020-10-12T10:33:45+02:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://andpalmier.com/papermod-cover.png"/>

<meta name="twitter:title" content="Emotet infection from PHP: generation of a malicious doc"/>
<meta name="twitter:description" content="Analysis of a PHP file used to generate a document containing malicious macros for Emotet infection"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://andpalmier.com/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Emotet infection from PHP: generation of a malicious doc",
      "item": "https://andpalmier.com/posts/emotet-php-maldoc/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Emotet infection from PHP: generation of a malicious doc",
  "name": "Emotet infection from PHP: generation of a malicious doc",
  "description": "Analysis of a PHP file used to generate a document containing malicious macros for Emotet infection",
  "keywords": [
    "malware", "emotet", "threat analysis"
  ],
  "articleBody": "Introduction During 2020, the Emotet malware distribution was silent between the beginning of February and the middle of July; this was the longest known break for Emotet. After this pause, the email campaigns started again, with multiple vendors reporting that hundreds of thousands of messages were detected every day1 2.\nThere is a long list of security researchers on Twitter that are interested in Emotet, with many accounts sharing samples and findings every day. During this summer I started writing multiple threads reporting abused “.it” domains which were used to distribute this malware. While I was working on one of this daily threads, I found something interesting:\nThis domain was reported in multiple occasions during the summer, and it was seen for the first time at the end of July:\nScreenshot from URLhaus\nI downloaded malware.zip and extracted the content. Although the PHP file in this archive is not detected as malicious in VirusTotal, it is actually used to download a document which contains malicious macros that will attempt to infect the machine.\nBackground The Emotet malware was firstly identified in 2014. At that time it was acting as a banking malware, attempting to steal sensitive data; however, during these years, several features were added such as the malspam distribution and the further installation of other malware. Emotet is currently considered one of the most costly threats, affecting not only individuals, but also private organizations, and even governments.\nThe primary distribution method for Emotet is through malspam: the malware is able to detect the contacts list of the infected machine and to replicate itself by sending emails to these contacts. In addition, since the email will be sent from an hijacked account, these will look less suspicious to the recipients.\nThe infection methods are multiple: malicious links, document containing macros or scripts. In this case, we will take a look at a PHP file which generates a malicious document file containing macros to infect the machine.\nAnalysis of the PHP downloader malware.zip contains a single PHP file (index.php), which reports August 25th as a modification date. Before analyzing the PHP file, it’s worth noting that only the archive malware.zip is found on VirusTotal, with 0 detections for the multiple engines and the first submission from September 26th.\nmalware.zip on VirusTotal\nThe PHP file, instead, has 0 matches.\nindex.php on VirusTotal\nBasic string obfuscation The first function that should be discussed in this analysis is called d5f44d5a7878a4(). Indeed, index.php contains some obfuscated strings to avoid being detected as malicious, and this function is used to de-obfuscate these strings. Here is the content of the function:\npublic function d5f44d5a7878a4($s) { $string = base64_decode($s); return explode('::', $string, 2)[1]; } We can see that it was used a very basic obfuscation technique. The de-obfuscation function decodes the given string with Base64 and proceed to create an array of strings by splitting the decoded string on the following sequence of characters \"::\". The return value of d5f44d5a7878a4() is contained in the second element of the array obtained after the split.\nFor instance, d5f44d5a7878a4() is called later in the file in this way:\n$qString = $this-\u003ed5f44d5a7878a4(\"TGhDY1VXdENMUT09OjpRVUVSWV9TVFJJTkc=\"); Decoding “TGhDY1VXdENMUT09OjpRVUVSWV9TVFJJTkc=” with Base64 we obtain “LhCcUWtCLQ==::QUERY_STRING”, thus the variable $qString1 will contain “QUERY_STRING”.\nEntry point The entry point of index.php is represented by the p5f44d5a786a7c() function. Here are the very first lines:\npublic function p5f44d5a786a7c() { $qString = $this-\u003ed5f44d5a7878a4(\"TGhDY1VXdENMUT09OjpRVUVSWV9TVFJJTkc=\"); if (!empty($_SERVER[$qString])) { return $_SERVER[$qString]; } As we already saw it before, we know that the function will just return the full query string if its not empty. If we go on, we will find:\n$path = '.' . sha1(basename(dirname(__FILE__))); if (($fp = fopen($path, 'c+')) !== false) { if (flock($fp, LOCK_EX)) { $stat = array(); $fileSize = filesize($path); if ($fileSize \u003e 0) { $stat = json_decode(fread($fp, $fileSize), true); } The function will now create a hidden JSON file (it has a \".\" at the beginning) having as a filename the SHA-1 hash of the name of the current directory.\n$platform = $this-\u003egetPlatform(); if (!isset($stat[$platform]) || !is_int($stat[$platform])) { $stat[$platform] = 1; } else { $stat[$platform]++; } fseek($fp, 0); fwrite($fp, json_encode($stat)); fflush($fp); flock($fp, LOCK_UN); } fclose($fp); } As we can see from the code above, the previously created JSON file is used to count how many instances of different platforms visited the page. The getPlatform() function contains the following:\nprivate function getPlatform() { // $userAgent = HTTP_USER_AGENT $userAgent = ( isset($_SERVER[$this-\u003e d5f44d5a7878a4(\"YWV6ejFFekE5TE5NbVE9PTo6SFRUUF9VU0VSX0FHRU5U\")]) ? $_SERVER[$this-\u003e d5f44d5a7878a4(\"YWV6ejFFekE5TE5NbVE9PTo6SFRUUF9VU0VSX0FHRU5U\")] : '' ); $platform = 0; // PLATFORM_UNKNOWN if (stripos($userAgent, $this-\u003e d5f44d5a7878a4(\"N3VFR0dla2xiZz09Ojp3aW5kb3dz\")) !== false) { $platform = 4; // PLATFORM_WINDOWS -\u003e windows } else if (stripos($userAgent, $this-\u003e d5f44d5a7878a4(\"QlFuRXdiZlRKZz09OjppUGFk\")) !== false) { $platform = 2; // PLATFORM_APPLE -\u003e BQnEwbfTJg==::iPad } else if (stripos($userAgent, $this-\u003e d5f44d5a7878a4(\"V1hMdTYyTUw6OmlQb2Q=\")) !== false) { $platform = 2; // PLATFORM_APPLE -\u003e iPod } else if (stripos($userAgent, $this-\u003e d5f44d5a7878a4(\"N1c3WjVYeld1c0lQZmNnPTo6aVBob25l\")) !== false) { $platform = 2; // PLATFORM_APPLE -\u003e iPhone } elseif (stripos($userAgent, $this-\u003e d5f44d5a7878a4(\"NllXNWhXMk43RzR4UURFPTo6bWFj\")) !== false) { $platform = 2; // PLATFORM_APPLE -\u003e mac } elseif (stripos($userAgent, $this-\u003e d5f44d5a7878a4(\"V0RvWnVPZE5CZnpiZFdVZU93PT06OmFuZHJvaWQ=\")) !== false) { $platform = 1; // PLATFORM_ANDROID -\u003e android } elseif (stripos($userAgent, $this-\u003e d5f44d5a7878a4(\"eVhldjU2RFlYUT09OjpsaW51eA==\")) !== false) { $platform = 3; // PLATFORM_LINUX -\u003e linux } elseif (stripos($userAgent, $this-\u003e d5f44d5a7878a4(\"TUU0ZmFKekdiRGFPaU42WDo6d2lu\")) !== false) { $platform = 4; // PLATFORM_WINDOWS -\u003e win } elseif (stripos($userAgent, $this-\u003e d5f44d5a7878a4(\"cHJoVk9kN291L3FFN0ZxdTo6aU9T\")) !== false) { $platform = 2; // PLATFORM_APPLE -\u003e iOS } return $platform; } I have inserted some comments to make it easier to read, but the piece of code above is used to check the Navigator.platform attribute which every browser expose to the visited pages. Since we have different options, here is a quick recap of what we will get after the execution of getPlatform():\nUnkown -\u003e 0 Android -\u003e 1 Apple -\u003e 2 Linux\t-\u003e 3 Windows\t-\u003e 4 Unfortunately I was not able to access the original log file in the first screenshot.\nThe malicious document The following steps of index.php include a long list of headers being set. I have added again some comments to make it easier to read the code below, since the function d5f44d5a7878a4() is used to de-obfuscate strings while setting almost all the headers.\n// Resist Varnish-cache setcookie(uniqid(), time(), time() + 60, '/'); // Send cache headers // gmdate(\"D, d M Y H:i:s\" . \"GMT\") $timestamp = gmdate($this-\u003e d5f44d5a7878a4(\"N0s4eFRuRTBZMkNlenRiemlpWT06OkQsIGQgTSBZIEg6aTpz\")) . $this-\u003ed5f44d5a7878a4(\"SUZYQlBrOFJ6d20zNFl4cmNFVlY6OiBHTVQ=\"); // header(\"Cache-Control: no-cache, must-revalidate\") header($this-\u003ed5f44d5a7878a4( \"b0taWDZCUDRleW0veVh4WWtXNGQ6OkNhY2hlLUNvbnRyb2w6IG5vLWNhY2hlLCBtdXN0LXJldmFsaWRhdGU=\")); // header(\"Pragma: no-cache\") header($this-\u003ed5f44d5a7878a4( \"U29wSEl0YnRiMEU9OjpQcmFnbWE6IG5vLWNhY2hl\")); // header(\"Last-Modified:\" . $timestamp) header($this-\u003ed5f44d5a7878a4( \"L1VvdkIxND06Okxhc3QtTW9kaWZpZWQ6IA==\") . $timestamp); // header(\"Expires:\" . $timestamp) header($this-\u003ed5f44d5a7878a4( \"ZU44eGw1T2N2azlUZ1RUTVhNTU86OkV4cGlyZXM6IA==\") . $timestamp); // Send content headers $contentName = 'INV_O2GT57A7QBKNN7.doc'; $contentType = 'application/msword'; // header(\"Content-Type:\" . $contentType) header($this-\u003ed5f44d5a7878a4( \"RVpCZ041ZW5TWCtYeE00WGhSRlQ6OkNvbnRlbnQtVHlwZTog\") . $contentType); // header(\"Content-Disposition: attachment; filename=\" . $contentName\") header($this-\u003ed5f44d5a7878a4( \"NUl6QUhHZ2VPcmpnTzJ0VkpZUTQ6OkNvbnRlbnQtRGlzcG9zaXRpb246IGF0dGFjaG1lbnQ7IGZpbGVuYW1lPSI=\") . $contentName . '\"'); // header(\"Content-Transfer-Encoding: binary\") header($this-\u003ed5f44d5a7878a4( \"ekFUS003Szl3Zz09OjpDb250ZW50LVRyYW5zZmVyLUVuY29kaW5nOiBiaW5hcnk=\")); It’s also worth noting that the contentName and contentType (respectively the filename and the file type) are also specified.\nThe only remaining step is to set the actual content of the malicious document file. This content is hardcoded in the $contentData variable; unfortunately the string is too long to be reported here, but here is a screenshot:\nJust few lines of the encoded malicious document\nThe string in $contentData is then used to create the document as follows:\nreturn gzinflate(base64_decode($contentData)); After decoding it with Base64 and inflating the result, the malicious document is ready and the browser used by the victim will prompt the download of a file called INV_O2GT57A7QBKNN7.doc. I have created the following CyberChef3 recipe to replicate this last step from index.php:\nFrom_Base64('A-Za-z0-9+/=',true) Raw_Inflate(0,0,'Block',false,false) SHA2('256') I have included in the recipe an additional step which creates the hash of the file, that can be used to detect if it’s malicious.\nYou can also see the CyberChef recipe by clicking here.\nThe document file obtained at the end of the execution of index.php is obviously malicious, being detected by multiple engines in VirusTotal, as you can see from the screenshot below:\nScreenshot from VirusTotal\nIf you want a sample of the file, you can find it in the MalwareBazaar database following this link.\nIOCs Here is a list of the hashes of files which were analyzed in the post:\nmalware.zip\tdb1617dc4a09fe856aea8041b90e73467e8d51ad4bdc1fd9a7e0a3197e66339c index.php\ta48791d0e22ba693529285555ebb559bac1786bd703406deb5e1ef9ee8616cc4 INV_O2GT57A7QBKNN7.doc\ta302a49cafa48ab0b8d686124f89eb0517a014f31fcb5dc4eb8b574854fbc0c8 If you want to take a look at the original PHP file, you can find it here.\nConclusion In this post we analyzed a PHP file used to distribute Emotet, a Trojan that has been active since 2014. We saw how index.php uses some basic obfuscation, especially when setting the headers; it also logs which types of OSs are accessing the page in a JSON file.\nAt the end of the execution, a malicious document called INV_O2GT57A7QBKNN7.doc is ready for the download.\nIf you are interested in Emotet, follow @Cryptolaemus1 on Twitter and the people in the Cryptolaemus team.\nA Comprehensive Look at Emotet’s Summer 2020 Return on ProofPoint ↩︎\nEmotet botnet returns after a five-month absence on ZDNet ↩︎\nCyberChef ↩︎\n",
  "wordCount" : "1454",
  "inLanguage": "en",
  "datePublished": "2020-10-12T10:33:45+02:00",
  "dateModified": "2020-10-12T10:33:45+02:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://andpalmier.com/posts/emotet-php-maldoc/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "andpalmier",
    "logo": {
      "@type": "ImageObject",
      "url": "https://andpalmier.com/images/favicon-32x32.png"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://andpalmier.com/" accesskey="h" title="andpalmier (Alt + H)">andpalmier</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://andpalmier.com/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://andpalmier.com/about/" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Emotet infection from PHP: generation of a malicious doc
    </h1>
    <div class="post-meta"><span title='2020-10-12 10:33:45 +0200 CEST'>October 12, 2020</span>&nbsp;·&nbsp;7 min

</div>
  </header> 
  <div class="post-content"><h2 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h2>
<p>During 2020, the Emotet malware distribution was silent between the beginning of February and the middle of July; this was the longest known break for Emotet. After this pause, the email campaigns started again, with multiple vendors reporting that hundreds of thousands of messages were detected every day<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>.</p>
<p>There is a long list of security researchers on Twitter that are interested in Emotet, with many accounts sharing samples and findings every day. During this summer I started writing multiple threads reporting abused &ldquo;.it&rdquo; domains which were used to distribute this malware. While I was working on one of this daily threads, I found something interesting:</p>
<figure class="align-center ">
    <img loading="lazy" src="/images/posts/emotet/indexof.png#center"
         alt="finding the sample"/> 
</figure>

<p>This domain was reported in multiple occasions during the summer, and it was seen for the first time at the end of July:</p>
<figure class="align-center ">
    <img loading="lazy" src="/images/posts/emotet/firsttime.png#center"
         alt="URLhaus screenshot"/> <figcaption>
            <p>Screenshot from <a href="https://urlhaus.abuse.ch/url/420080/" target="_blank" rel="noopener">URLhaus</a></p>
        </figcaption>
</figure>

<p>I downloaded <code>malware.zip</code> and extracted the content. Although the PHP file in this archive is not detected as malicious in VirusTotal, it is actually used to download a document which contains malicious macros that will attempt to infect the machine.</p>
<h2 id="background">Background<a hidden class="anchor" aria-hidden="true" href="#background">#</a></h2>
<p>The Emotet malware was firstly identified in 2014. At that time it was acting as a banking malware, attempting to steal sensitive data; however, during these years, several features were added such as the malspam distribution and the further installation of other malware.
Emotet is currently considered one of the most costly threats, affecting not only individuals, but also private organizations, and even governments.</p>
<p>The primary distribution method for Emotet is through malspam: the malware is able to detect the contacts list of the infected machine and to replicate itself by sending emails to these contacts. In addition, since the email will be sent from an hijacked account, these will look less suspicious to the recipients.</p>
<p>The infection methods are multiple: malicious links, document containing macros or scripts. In this case, we will take a look at a PHP file which generates a malicious document file containing macros to infect the machine.</p>
<h2 id="analysis-of-the-php-downloader">Analysis of the PHP downloader<a hidden class="anchor" aria-hidden="true" href="#analysis-of-the-php-downloader">#</a></h2>
<p><em>malware.zip</em> contains a single PHP file (<code>index.php</code>), which reports August 25th as a modification date. Before analyzing the PHP file, it&rsquo;s worth noting that only the archive <em>malware.zip</em> is found on VirusTotal, with 0 detections for the multiple engines and the first submission from September 26th.</p>
<figure class="align-center ">
    <img loading="lazy" src="/images/posts/emotet/vtzip.png#center"
         alt="VirusTotal detection"/> <figcaption>
            <p><a href="https://www.virustotal.com/gui/file/db1617dc4a09fe856aea8041b90e73467e8d51ad4bdc1fd9a7e0a3197e66339c/detection" target="_blank" rel="noopener">malware.zip on VirusTotal</a></p>
        </figcaption>
</figure>

<p>The PHP file, instead, has 0 matches.</p>
<figure class="align-center ">
    <img loading="lazy" src="/images/posts/emotet/vtphp.png#center"
         alt="VirusTotal detection"/> <figcaption>
            <p><a href="https://www.virustotal.com/gui/file/a48791d0e22ba693529285555ebb559bac1786bd703406deb5e1ef9ee8616cc4/detection" target="_blank" rel="noopener">index.php on VirusTotal</a></p>
        </figcaption>
</figure>

<h3 id="basic-string-obfuscation">Basic string obfuscation<a hidden class="anchor" aria-hidden="true" href="#basic-string-obfuscation">#</a></h3>
<p>The first function that should be discussed in this analysis is called <code>d5f44d5a7878a4()</code>. Indeed, <code>index.php</code> contains some obfuscated strings to avoid being detected as malicious, and this function is used to de-obfuscate these strings. Here is the content of the function:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">d5f44d5a7878a4</span><span class="p">(</span><span class="nv">$s</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$string</span> <span class="o">=</span> <span class="nx">base64_decode</span><span class="p">(</span><span class="nv">$s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;::&#39;</span><span class="p">,</span> <span class="nv">$string</span><span class="p">,</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>We can see that it was used a very basic obfuscation technique. The de-obfuscation function decodes the given string with Base64 and proceed to create an array of strings by splitting the decoded string on the following sequence of characters <em>&quot;::&quot;</em>. The return value of <code>d5f44d5a7878a4()</code> is contained in the second element of the array obtained after the split.</p>
<p>For instance, <code>d5f44d5a7878a4()</code> is called later in the file in this way:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$qString</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">d5f44d5a7878a4</span><span class="p">(</span><span class="s2">&#34;TGhDY1VXdENMUT09OjpRVUVSWV9TVFJJTkc=&#34;</span><span class="p">);</span>
</span></span></code></pre></div><p>Decoding <em>&ldquo;TGhDY1VXdENMUT09OjpRVUVSWV9TVFJJTkc=&rdquo;</em> with Base64 we obtain <em>&ldquo;LhCcUWtCLQ==::QUERY_STRING&rdquo;</em>, thus the variable <code>$qString1</code> will contain <em>&ldquo;QUERY_STRING&rdquo;</em>.</p>
<h3 id="entry-point">Entry point<a hidden class="anchor" aria-hidden="true" href="#entry-point">#</a></h3>
<p>The entry point of <code>index.php</code> is represented by the <code>p5f44d5a786a7c()</code> function. Here are the very first lines:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">function</span> <span class="nf">p5f44d5a786a7c</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$qString</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">d5f44d5a7878a4</span><span class="p">(</span><span class="s2">&#34;TGhDY1VXdENMUT09OjpRVUVSWV9TVFJJTkc=&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="nv">$qString</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="nv">$qString</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><p>As we already saw it before, we know that the function will just return the full query string if its not empty. If we go on, we will find:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$path</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span> <span class="o">.</span> <span class="nx">sha1</span><span class="p">(</span><span class="nx">basename</span><span class="p">(</span><span class="nx">dirname</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">((</span><span class="nv">$fp</span> <span class="o">=</span> <span class="nx">fopen</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="s1">&#39;c+&#39;</span><span class="p">))</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">flock</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nx">LOCK_EX</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nv">$stat</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$fileSize</span> <span class="o">=</span> <span class="nx">filesize</span><span class="p">(</span><span class="nv">$path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$fileSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    <span class="nv">$stat</span> <span class="o">=</span> <span class="nx">json_decode</span><span class="p">(</span><span class="nx">fread</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nv">$fileSize</span><span class="p">),</span> <span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span></code></pre></div><p>The function will now create a hidden JSON file (it has a <em>&quot;.&quot;</em> at the beginning) having as a filename the SHA-1 hash of the name of the current directory.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl">	<span class="nv">$platform</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getPlatform</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$stat</span><span class="p">[</span><span class="nv">$platform</span><span class="p">])</span> <span class="o">||</span> <span class="o">!</span><span class="nx">is_int</span><span class="p">(</span><span class="nv">$stat</span><span class="p">[</span><span class="nv">$platform</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    <span class="nv">$stat</span><span class="p">[</span><span class="nv">$platform</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$stat</span><span class="p">[</span><span class="nv">$platform</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">fseek</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fwrite</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nx">json_encode</span><span class="p">(</span><span class="nv">$stat</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fflush</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nx">flock</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nx">LOCK_UN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>As we can see from the code above, the previously created JSON file is used to count how many instances of different platforms visited the page. The <code>getPlatform()</code> function contains the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">private</span> <span class="k">function</span> <span class="nf">getPlatform</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// $userAgent = HTTP_USER_AGENT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$userAgent</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="na">d5f44d5a7878a4</span><span class="p">(</span><span class="s2">&#34;YWV6ejFFekE5TE5NbVE9PTo6SFRUUF9VU0VSX0FHRU5U&#34;</span><span class="p">)])</span> <span class="o">?</span>
</span></span><span class="line"><span class="cl">	    <span class="nv">$_SERVER</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">		<span class="na">d5f44d5a7878a4</span><span class="p">(</span><span class="s2">&#34;YWV6ejFFekE5TE5NbVE9PTo6SFRUUF9VU0VSX0FHRU5U&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">		<span class="o">:</span> <span class="s1">&#39;&#39;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$platform</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// PLATFORM_UNKNOWN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">stripos</span><span class="p">(</span><span class="nv">$userAgent</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="na">d5f44d5a7878a4</span><span class="p">(</span><span class="s2">&#34;N3VFR0dla2xiZz09Ojp3aW5kb3dz&#34;</span><span class="p">))</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$platform</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// PLATFORM_WINDOWS -&gt; windows
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">stripos</span><span class="p">(</span><span class="nv">$userAgent</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="na">d5f44d5a7878a4</span><span class="p">(</span><span class="s2">&#34;QlFuRXdiZlRKZz09OjppUGFk&#34;</span><span class="p">))</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$platform</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// PLATFORM_APPLE -&gt; BQnEwbfTJg==::iPad
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">stripos</span><span class="p">(</span><span class="nv">$userAgent</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="na">d5f44d5a7878a4</span><span class="p">(</span><span class="s2">&#34;V1hMdTYyTUw6OmlQb2Q=&#34;</span><span class="p">))</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$platform</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// PLATFORM_APPLE -&gt; iPod
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">stripos</span><span class="p">(</span><span class="nv">$userAgent</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="na">d5f44d5a7878a4</span><span class="p">(</span><span class="s2">&#34;N1c3WjVYeld1c0lQZmNnPTo6aVBob25l&#34;</span><span class="p">))</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$platform</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// PLATFORM_APPLE -&gt; iPhone
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nx">stripos</span><span class="p">(</span><span class="nv">$userAgent</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="na">d5f44d5a7878a4</span><span class="p">(</span><span class="s2">&#34;NllXNWhXMk43RzR4UURFPTo6bWFj&#34;</span><span class="p">))</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$platform</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// PLATFORM_APPLE -&gt; mac
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nx">stripos</span><span class="p">(</span><span class="nv">$userAgent</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="na">d5f44d5a7878a4</span><span class="p">(</span><span class="s2">&#34;V0RvWnVPZE5CZnpiZFdVZU93PT06OmFuZHJvaWQ=&#34;</span><span class="p">))</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$platform</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// PLATFORM_ANDROID -&gt; android
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nx">stripos</span><span class="p">(</span><span class="nv">$userAgent</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="na">d5f44d5a7878a4</span><span class="p">(</span><span class="s2">&#34;eVhldjU2RFlYUT09OjpsaW51eA==&#34;</span><span class="p">))</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$platform</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="c1">// PLATFORM_LINUX -&gt; linux
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nx">stripos</span><span class="p">(</span><span class="nv">$userAgent</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="na">d5f44d5a7878a4</span><span class="p">(</span><span class="s2">&#34;TUU0ZmFKekdiRGFPaU42WDo6d2lu&#34;</span><span class="p">))</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$platform</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// PLATFORM_WINDOWS -&gt; win
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nx">stripos</span><span class="p">(</span><span class="nv">$userAgent</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="na">d5f44d5a7878a4</span><span class="p">(</span><span class="s2">&#34;cHJoVk9kN291L3FFN0ZxdTo6aU9T&#34;</span><span class="p">))</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$platform</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// PLATFORM_APPLE -&gt; iOS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$platform</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>I have inserted some comments to make it easier to read, but the piece of code above is used to check the <em>Navigator.platform</em> attribute which every browser expose to the visited pages. Since we have different options, here is a quick recap of what we will get after the execution of <code>getPlatform()</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Unkown 	-&gt; 0
</span></span><span class="line"><span class="cl">Android -&gt; 1
</span></span><span class="line"><span class="cl">Apple 	-&gt; 2
</span></span><span class="line"><span class="cl">Linux	-&gt; 3
</span></span><span class="line"><span class="cl">Windows	-&gt; 4
</span></span></code></pre></div><p>Unfortunately I was not able to access the original log file in the first screenshot.</p>
<h3 id="the-malicious-document">The malicious document<a hidden class="anchor" aria-hidden="true" href="#the-malicious-document">#</a></h3>
<p>The following steps of <code>index.php</code> include a long list of headers being set. I have added again some comments to make it easier to read the code below, since the function <code>d5f44d5a7878a4()</code> is used to de-obfuscate strings while setting almost all the headers.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// Resist Varnish-cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">setcookie</span><span class="p">(</span><span class="nx">uniqid</span><span class="p">(),</span> <span class="nx">time</span><span class="p">(),</span> <span class="nx">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">60</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Send cache headers
</span></span></span><span class="line"><span class="cl"><span class="c1">// gmdate(&#34;D, d M Y H:i:s&#34; . &#34;GMT&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nv">$timestamp</span> <span class="o">=</span> <span class="nx">gmdate</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="na">d5f44d5a7878a4</span><span class="p">(</span><span class="s2">&#34;N0s4eFRuRTBZMkNlenRiemlpWT06OkQsIGQgTSBZIEg6aTpz&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">d5f44d5a7878a4</span><span class="p">(</span><span class="s2">&#34;SUZYQlBrOFJ6d20zNFl4cmNFVlY6OiBHTVQ=&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// header(&#34;Cache-Control: no-cache, must-revalidate&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">header</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">d5f44d5a7878a4</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;b0taWDZCUDRleW0veVh4WWtXNGQ6OkNhY2hlLUNvbnRyb2w6IG5vLWNhY2hlLCBtdXN0LXJldmFsaWRhdGU=&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// header(&#34;Pragma: no-cache&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">header</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">d5f44d5a7878a4</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;U29wSEl0YnRiMEU9OjpQcmFnbWE6IG5vLWNhY2hl&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// header(&#34;Last-Modified:&#34; . $timestamp)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">header</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">d5f44d5a7878a4</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;L1VvdkIxND06Okxhc3QtTW9kaWZpZWQ6IA==&#34;</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$timestamp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// header(&#34;Expires:&#34; . $timestamp)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">header</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">d5f44d5a7878a4</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;ZU44eGw1T2N2azlUZ1RUTVhNTU86OkV4cGlyZXM6IA==&#34;</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$timestamp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Send content headers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nv">$contentName</span> <span class="o">=</span> <span class="s1">&#39;INV_O2GT57A7QBKNN7.doc&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$contentType</span> <span class="o">=</span> <span class="s1">&#39;application/msword&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// header(&#34;Content-Type:&#34; . $contentType)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">header</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">d5f44d5a7878a4</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;RVpCZ041ZW5TWCtYeE00WGhSRlQ6OkNvbnRlbnQtVHlwZTog&#34;</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$contentType</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// header(&#34;Content-Disposition: attachment; filename=&#34; . $contentName&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">header</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">d5f44d5a7878a4</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;NUl6QUhHZ2VPcmpnTzJ0VkpZUTQ6OkNvbnRlbnQtRGlzcG9zaXRpb246IGF0dGFjaG1lbnQ7IGZpbGVuYW1lPSI=&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span> <span class="nv">$contentName</span> <span class="o">.</span> <span class="s1">&#39;&#34;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// header(&#34;Content-Transfer-Encoding: binary&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">header</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">d5f44d5a7878a4</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;ekFUS003Szl3Zz09OjpDb250ZW50LVRyYW5zZmVyLUVuY29kaW5nOiBiaW5hcnk=&#34;</span><span class="p">));</span>
</span></span></code></pre></div><p>It&rsquo;s also worth noting that the <code>contentName</code> and <code>contentType</code> (respectively the filename and the file type) are also specified.</p>
<p>The only remaining step is to set the actual content of the malicious document file. This content is hardcoded in the <code>$contentData</code> variable; unfortunately the string is too long to be reported here, but here is a screenshot:</p>
<figure class="align-center ">
    <img loading="lazy" src="/images/posts/emotet/maliciouscontent.png#center"
         alt="few lines of encoded document"/> <figcaption>
            <p>Just few lines of the encoded malicious document</p>
        </figcaption>
</figure>

<p>The string in <code>$contentData</code> is then used to create the document as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">return</span> <span class="nx">gzinflate</span><span class="p">(</span><span class="nx">base64_decode</span><span class="p">(</span><span class="nv">$contentData</span><span class="p">));</span>
</span></span></code></pre></div><p>After decoding it with Base64 and inflating the result, the malicious document is ready and the browser used by the victim will prompt the download of a file called <code>INV_O2GT57A7QBKNN7.doc</code>. I have created the following CyberChef<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup> recipe to replicate this last step from <code>index.php</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">From_Base64(&#39;A-Za-z0-9+/=&#39;,true)
</span></span><span class="line"><span class="cl">Raw_Inflate(0,0,&#39;Block&#39;,false,false)
</span></span><span class="line"><span class="cl">SHA2(&#39;256&#39;)
</span></span></code></pre></div><p>I have included in the recipe an additional step which creates the hash of the file, that can be used to detect if it&rsquo;s malicious.</p>
<p>You can also see the CyberChef recipe by clicking <a href="https://gchq.github.io/CyberChef/#recipe=From_Base64%28%27A-Za-z0-9%2B/%3D%27,true%29Raw_Inflate%280,0,%27Block%27,false,false%29SHA2%28%27256%27%29" target="_blank" rel="noopener">here</a>.</p>
<p>The document file obtained at the end of the execution of <code>index.php</code> is obviously malicious, being detected by multiple engines in VirusTotal, as you can see from the screenshot below:</p>
<figure class="align-center ">
    <img loading="lazy" src="/images/posts/emotet/vtdoc.png#center"
         alt="VirusTotal detection of the generated doc"/> <figcaption>
            <p>Screenshot from <a href="https://www.virustotal.com/gui/file/a302a49cafa48ab0b8d686124f89eb0517a014f31fcb5dc4eb8b574854fbc0c8/detection" target="_blank" rel="noopener">VirusTotal</a></p>
        </figcaption>
</figure>

<p>If you want a sample of the file, you can find it in the MalwareBazaar database following <a href="https://bazaar.abuse.ch/browse.php?search=a302a49cafa48ab0b8d686124f89eb0517a014f31fcb5dc4eb8b574854fbc0c8" target="_blank" rel="noopener">this link</a>.</p>
<h2 id="iocs">IOCs<a hidden class="anchor" aria-hidden="true" href="#iocs">#</a></h2>
<p>Here is a list of the hashes of files which were analyzed in the post:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">malware.zip	db1617dc4a09fe856aea8041b90e73467e8d51ad4bdc1fd9a7e0a3197e66339c
</span></span><span class="line"><span class="cl">index.php	a48791d0e22ba693529285555ebb559bac1786bd703406deb5e1ef9ee8616cc4
</span></span><span class="line"><span class="cl">INV_O2GT57A7QBKNN7.doc	a302a49cafa48ab0b8d686124f89eb0517a014f31fcb5dc4eb8b574854fbc0c8
</span></span></code></pre></div><p>If you want to take a look at the original PHP file, you can find it <a href="https://gist.github.com/andpalmier/e9a5cdd40fd2db751c07da641bc33bea" target="_blank" rel="noopener">here</a>.</p>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>In this post we analyzed a PHP file used to distribute Emotet, a Trojan that has been active since 2014. We saw how <code>index.php</code> uses some basic obfuscation, especially when setting the headers; it also logs which types of OSs are accessing the page in a JSON file.</p>
<p>At the end of the execution, a malicious document called <code>INV_O2GT57A7QBKNN7.doc</code> is ready for the download.</p>
<p>If you are interested in Emotet, follow <a href="https://twitter.com/Cryptolaemus1" target="_blank" rel="noopener">@Cryptolaemus1</a> on Twitter and the people in the <a href="https://paste.cryptolaemus.com/about/" target="_blank" rel="noopener">Cryptolaemus team</a>.</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://www.proofpoint.com/us/blog/threat-insight/comprehensive-look-emotets-summer-2020-return" target="_blank" rel="noopener">A Comprehensive Look at Emotet’s Summer 2020 Return</a> on ProofPoint&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://www.zdnet.com/article/emotet-botnet-returns-after-a-five-month-absence/" target="_blank" rel="noopener">Emotet botnet returns after a five-month absence</a> on ZDNet&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><a href="https://gchq.github.io/CyberChef/" target="_blank" rel="noopener">CyberChef</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://andpalmier.com/tags/malware/">Malware</a></li>
      <li><a href="https://andpalmier.com/tags/emotet/">Emotet</a></li>
      <li><a href="https://andpalmier.com/tags/threat-analysis/">Threat Analysis</a></li>
    </ul>
  </footer><script src="https://utteranc.es/client.js"
        repo="andpalmier/andpalmier.github.io"
        issue-term="og:title"
        label="comment"
        theme="preferred-color-scheme"
        crossorigin="anonymous"
        async>
</script>

</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://andpalmier.com/">andpalmier</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a><script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
const images = Array.from(document.querySelectorAll(".post-content img"));
images.forEach(img => {
  mediumZoom(img, {
    margin: 0,  
    scrollOffset: 40,  
    container: null,  
    template: null,  
    background: 'rgba(0, 0, 0, 0.8)'
  });
});
</script>


<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
