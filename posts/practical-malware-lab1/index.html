<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Practical malware analysis: solutions for Lab 1 | andpalmier</title>
<meta name="keywords" content="malware, malware-analysis, exercises">
<meta name="description" content="Solutions for the first lab of &lsquo;Practical malware analysis&rsquo;">
<meta name="author" content="">
<link rel="canonical" href="https://andpalmier.com/posts/practical-malware-lab1/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.347f0a729e38312b74d7f1f92ddd7a482874d53d880ba25e4c1743a3f02201c7.css" integrity="sha256-NH8Kcp44MSt01/H5Ld16SCh01T2IC6JeTBdDo/AiAcc=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://andpalmier.com/images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://andpalmier.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://andpalmier.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://andpalmier.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://andpalmier.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://andpalmier.com/posts/practical-malware-lab1/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="Practical malware analysis: solutions for Lab 1" />
<meta property="og:description" content="Solutions for the first lab of &lsquo;Practical malware analysis&rsquo;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://andpalmier.com/posts/practical-malware-lab1/" />
<meta property="og:image" content="https://andpalmier.com/papermod-cover.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-21T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-04-21T00:00:00+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://andpalmier.com/papermod-cover.png" />
<meta name="twitter:title" content="Practical malware analysis: solutions for Lab 1"/>
<meta name="twitter:description" content="Solutions for the first lab of &lsquo;Practical malware analysis&rsquo;"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://andpalmier.com/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Practical malware analysis: solutions for Lab 1",
      "item": "https://andpalmier.com/posts/practical-malware-lab1/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Practical malware analysis: solutions for Lab 1",
  "name": "Practical malware analysis: solutions for Lab 1",
  "description": "Solutions for the first lab of \u0026lsquo;Practical malware analysis\u0026rsquo;",
  "keywords": [
    "malware", "malware-analysis", "exercises"
  ],
  "articleBody": " I am trying to acquire some knowledge on malware analysis by using ‘Practical Malware Analysis’ (by Sikorski, Michael, and Andrew Honig, 2012). I will publish my solutions of the exercises as soon as I complete them; here you can find all the executables for the labs.\nNOTE: I will try to use Linux utilities (such as pev, wrestool and Detect It Easy) instead of the Windows tools which are mentioned in the book.\nThe first chapter was about basic static analysis techniques, you can find some notes about it in this repo.\nLab 1-1 Upload the files to VirusTotal and view the reports. Does either file match any existing antivirus signatures? Uploading the files on VirusTotal, the results are that Lab01-01.dll is flagged as malicious by 34 engines, and Lab01-01.exe by 41. Here are links to the reports for Lab01-01.dll and Lab01-01.exe.\nWhen were these files compiled? I used pev to detect the timestamp of the compilation:\n$ readpe Lab01-01.dll | grep \"time stamp\" Date/time stamp: 1292775398 (Sun, 19 Dec 2010 16:16:38 UTC) $ readpe Lab01-01.exe | grep \"time stamp\" Date/time stamp: 1292775379 (Sun, 19 Dec 2010 16:16:19 UTC) Are there any indications that either of these files is packed or obfuscated? If so, what are these indicators? The output of strings on both the files does not include LoadLibrary or GetProcAddress. We can have confirmation that these are not packed by using Detect It Easy:\n$ diec Lab01-01.dll PE: compiler: Microsoft Visual C/C++(6.0)[msvcrt] PE: linker: Microsoft Linker(6.0)[DLL32] $ diec Lab01-01.exe PE: compiler: Microsoft Visual C/C++(6.0)[msvcrt] PE: linker: Microsoft Linker(6.0)[DLL32] If the given file is packed, the diec command would list the packer used in the output.\nDo any imports hint at what this malware does? If so, which imports are they? pev allows us to check the imported functions by using the -i flag, for instance:\n$ readpe -i Lab01-01.dll Imported functions Library Name: KERNEL32.dll Functions Function Hint: 662 Name: Sleep Function Hint: 68 Name: CreateProcessA Function Hint: 63 Name: CreateMutexA Function Hint: 493 Name: OpenMutexA Function Hint: 27 Name: CloseHandle Library Name: WS2_32.dll Functions Function Ordinal: 23 Function Ordinal: 115 Function Ordinal: 11 Function Ordinal: 4 Function Ordinal: 19 Function Ordinal: 22 Function Ordinal: 16 Function Ordinal: 3 Function Ordinal: 116 Function Ordinal: 9 Library Name: MSVCRT.dll Functions Function Hint: 157 Name: _adjust_fdiv Function Hint: 657 Name: malloc Function Hint: 271 Name: _initterm Function Hint: 606 Name: free Function Hint: 704 Name: strncmp In order to make the blog post more readable, I’ll summarize the findings and list only the interesting functions.\nLab01–01.exe imports functions from KERNEL32.dll and MSVCRT.dll Lab01–01.dll imports functions from KERNEL32.dll, MSVCRT.dll, and WS2_32.dll KERNEL32.dll contains important functionalities (like access and edit memory and files), thus is a common DLL to import. It is interesting to note the presence of FindFirstFileA and FindNextFileA in Lab01–01.exe, and CreateProcessA in Lab01–01.dll.\nWS2_32.dll is used for network functionalities, but in this case is imported by ordinals, thus we don’t have many additional information.\nAre there any other files or host-based indicators that you could look for on infected systems? Using strings on Lab01-01.exe file, we can see some interesting findings, such as:\nkerne132.dll kernel32.dll C:\\windows\\system32\\kerne132.dll Kernel32. Lab01-01.dll C:\\Windows\\System32\\Kernel32.dll WARNING_THIS_WILL_DESTROY_YOUR_MACHINE (my favorite) In particular, we can assume the existence of the file named kerne132.dll (with a 1 instead of an l) for infected machines.\nWhat network-based indicators could be used to find this malware on infected machines? Using strings on Lab01-01.dll, we can see an IP address: 127.26.152.13.\nWhat would you guess is the purpose of these files? Other interesting results running strings are: exec, hello, CreateProcess and sleep; which are names of functions. Based on the findings provided, we can say that these two files may be used to create a backdoor.\nLab 1-2 Upload the Lab01-02.exe file to VirusTotal. Does it match any existing antivirus definitions? The file is considered malicious by 55 engines, here is the report.\nAre there any indications that this file is packed or obfuscated? If so, what are these indicators? If the file is packed, unpack it if possible. Detect It Easy finds that UPX has been used in this case:\n$ diec Lab01-02.exe PE: packer: UPX(3.04)[NRV,best] PE: compiler: Microsoft Visual C/C++(6.0)[-] PE: linker: Microsoft Linker(6.0)[EXE32,console] We can then proceed to unpack the file with the following command:\n$ upx -d -o Lab01-02_unpacked.exe Lab01-02.exe Ultimate Packer for eXecutables Copyright (C) 1996 - 2020 UPX git-d7ba31+ Markus Oberhumer, Laszlo Molnar \u0026 John Reiser Jan 23rd 2020 File size Ratio Format Name -------------------- ------ ----------- ----------- 16384 \u003c- 3072 18.75% win32/pe Lab01-02_unpacked.exe Unpacked 1 file. Do any imports hint at this program’s functionality? If so, which imports are they and what do they tell you? As shown in the previous exercise, we can use readpe -i to check the imported functions. Here are the interesting findings:\nKERNEL32.DLL: SystemTimeToFileTime, GetModuleFileNameA, CreateMutexA, CreateThread and SetWaitableTimer ADVAPI32.DLL: CreateServiceA, StartServiceCtrlDispatcherA and OpenSCManagerA WININET.DLL: InternetOpenUrlA and InternetOpenA In particular, the last DLL file suggests that the file is communicating over the Internet.\nWhat host or network-based indicators could be used to identify this malware on infected machines? Again, strings is our friend: MalService, Malservice, HGL345,http://www.malwareanalysisbook.com and Internet Explorer 8.0. These results are suggesting that the file is creating a service (probably MalService?) and connecting to the URL.\nLab 1-3 Upload the Lab01-03.exe file to VirusTotal. Does it match any existing antivirus definitions? Lab01-03.exe is detected as malicious by 64 engines, here is the report.\nAre there any indications that this file is packed or obfuscated? If so, what are these indicators? If the file is packed, unpack it if possible. Scanning the file with diec shows that it is packed with FSG 1.0:\n$ diec Lab01-03.exe PE: packer: FSG(1.0)[-] PE: linker: unknown(0.0)[EXE32,console] Unfortunately it is not possible (AFAIK) to unpack it with upx, thus I cannot proceed:\n$ upx -d Lab01-03.exe Ultimate Packer for eXecutables Copyright (C) 1996 - 2020 UPX git-d7ba31+ Markus Oberhumer, Laszlo Molnar \u0026 John Reiser Jan 23rd 2020 File size Ratio Format Name -------------------- ------ ----------- ----------- upx: Lab01-03.exe: NotPackedException: not packed by UPX Unpacked 0 files. Do any imports hint at this program’s functionality? If so, which imports are they and what do they tell you? Being still packed, we have limited visibility on Lab01–03.exe. We can only see that it imports KERNEL32.DLL and uses the following functions: LoadLibraryA and GetProcAddress.\n$ readpe -i Lab01-03.exe Imported functions Library Name: KERNEL32.dll Functions Function Hint: 0 Name: LoadLibraryA Function Hint: 0 Name: GetProcAddress What host or network-based indicators could be used to identify this malware on infected machines? In this case, strings does not help us a lot, because the file is packed. Again we see LoadLibraryA and GetProcAddress. Some of the other strings seems to refer to OLE.\nLab 1-4 Upload the Lab01-04.exe file to VirusTotal. Does it match any existing antivirus definitions? The file is detected as malicious by 61 engines, here is the report.\nAre there any indications that this file is packed or obfuscated? If so, what are these indicators? If the file is packed, unpack it if possible. The file does not seem to be packed:\n$ diec Lab01-04.exe PE: compiler: Microsoft Visual C/C++(6.0)[msvcrt] PE: linker: Microsoft Linker(6.0*)[EXE32] When was this program compiled? The time stamp reported seems suspicious 🤔, considering that the book was published in 2012:\n$ readpe Lab01-04.exe | grep \"time stamp\" Date/time stamp: 1567204019 (Fri, 30 Aug 2019 22:26:59 UTC) It was probably modified, thus it’s not clear when the file was actually compiled.\nDo any imports hint at this program’s functionality? If so, which imports are they and what do they tell you? Here are the imports found with readpe -i:\nADVAPI32.dll: AdjustTokenPrivileges, LookupPrivilegeValueA and OpenProcessToken. KERNEL32.dll: CreateRemoteThread, MoveFileA, SizeofResource, LoadResource, GetModuleHandleA, OpenProcess, GetWindowsDirectoryA, WriteFile, GetCurrentProcess, CreateFileA, GetProcAddress, FindResourceA, LoadLibraryA and WinExec. Considering the functions used, we can say that the program will try to access protected files (SizeOfResource, FindResource, LoadResource, LookupPrivilegeValueA and AdjustTokenPrivilages) and create and execute files (CreateFile, WriteFile and WinExec).\nWhat host or network-based indicators could be used to identify this malware on infected machines? Here are the host and network-based indicators that can be found using strings:\nhost-based: C:\\WINDOWS\\system32\\wupdmgrd.exe and winup.exe network-based: http://www.practicalmalwareanalysis.com/updater.exe This file has one resource in the resource section. Use Resource Hacker to examine that resource, and then use it to extract the resource. What can you learn from the resource? We can list and extract the resources from a Windows binary using wrestool:\n$ wrestool -l Lab01-04.exe --type='BIN' --name=101 --language=1033 [offset=0x4060 size=16384] $ wrestool -x --raw --output=Lab01-04.bin Lab01-04.exe VirusTotal report Not packed: $ diec Lab01-04.bin PE: compiler: Microsoft Visual C/C++(6.0)[msvcrt] PE: linker: Microsoft Linker(6.0)[EXE32] Compiled on 1298765819 (Sun, 27 Feb 2011 00:16:59 UTC). Imports: KERNEl32.dll (WinExec) and urlmon.dll (URLDownloadToFileA) Interesting strings: \\system32\\wupdmgr.exe, winup.exe and www.malwareanalysisbok.com/updater.exe Considering the information obtained, we can assume that the Lab01-04.exe file will be used to change permissions to write in a directory and drop and execute the hidden resource, which contacts the network to download and run additional malware.\n",
  "wordCount" : "1496",
  "inLanguage": "en",
  "image": "https://andpalmier.com/papermod-cover.png","datePublished": "2020-04-21T00:00:00Z",
  "dateModified": "2020-04-21T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://andpalmier.com/posts/practical-malware-lab1/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "andpalmier",
    "logo": {
      "@type": "ImageObject",
      "url": "https://andpalmier.com/images/favicon-32x32.png"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://andpalmier.com/" accesskey="h" title="andpalmier (Alt + H)">andpalmier</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://andpalmier.com/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://andpalmier.com/about/" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Practical malware analysis: solutions for Lab 1
    </h1>
    <div class="post-meta"><span title='2020-04-21 00:00:00 +0000 UTC'>April 21, 2020</span>&nbsp;·&nbsp;8 min

</div>
  </header> 
  <div class="post-content"><figure class="align-center ">
    <img loading="lazy" src="/images/posts/practical-malware-lab1/practical-malware-header.png#center"
         alt="cover of Practical mawlare analysis"/> 
</figure>

<p>I am trying to acquire some knowledge on malware analysis by using <a href="https://practicalmalwareanalysis.com/" target="_blank" rel="noopener">&lsquo;Practical Malware Analysis&rsquo;</a> (by <em>Sikorski, Michael, and Andrew Honig, 2012</em>). I will publish my solutions of the exercises as soon as I complete them; <a href="https://github.com/mikesiko/PracticalMalwareAnalysis-Labs" target="_blank" rel="noopener">here</a> you can find all the executables for the labs.</p>
<p><strong>NOTE: I will try to use Linux utilities</strong> (such as <a href="http://pev.sourceforge.net" target="_blank" rel="noopener">pev</a>, <a href="https://linux.die.net/man/1/wrestool" target="_blank" rel="noopener">wrestool</a> and <a href="https://github.com/horsicq/Detect-It-Easy" target="_blank" rel="noopener">Detect It Easy</a>) <strong>instead of the Windows tools which are mentioned in the book.</strong></p>
<p>The first chapter was about basic static analysis techniques, you can find some notes about it <a href="https://github.com/andpalmier/PracticalMalwareSummary" target="_blank" rel="noopener">in this repo</a>.</p>
<h2 id="lab-1-1">Lab 1-1<a hidden class="anchor" aria-hidden="true" href="#lab-1-1">#</a></h2>
<ol>
<li><em>Upload the files to VirusTotal and view the reports. Does either file match any existing antivirus signatures?</em></li>
</ol>
<p>Uploading the files on VirusTotal, the results are that Lab01-01.dll is flagged as malicious by 34 engines, and Lab01-01.exe by 41. Here are links to the reports for <a href="https://www.virustotal.com/gui/file/f50e42c8dfaab649bde0398867e930b86c2a599e8db83b8260393082268f2dba/detection" target="_blank" rel="noopener">Lab01-01.dll</a> and <a href="https://www.virustotal.com/gui/file/58898bd42c5bd3bf9b1389f0eee5b39cd59180e8370eb9ea838a0b327bd6fe47/detection" target="_blank" rel="noopener">Lab01-01.exe</a>.</p>
<ol start="2">
<li><em>When were these files compiled?</em></li>
</ol>
<p>I used <a href="http://pev.sourceforge.net" target="_blank" rel="noopener">pev</a> to detect the timestamp of the compilation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ readpe Lab01-01.dll <span class="p">|</span> grep <span class="s2">&#34;time stamp&#34;</span>
</span></span><span class="line"><span class="cl">Date/time stamp:                 <span class="m">1292775398</span> <span class="o">(</span>Sun, <span class="m">19</span> Dec <span class="m">2010</span> 16:16:38 UTC<span class="o">)</span>
</span></span><span class="line"><span class="cl">$ readpe Lab01-01.exe <span class="p">|</span> grep <span class="s2">&#34;time stamp&#34;</span>
</span></span><span class="line"><span class="cl">Date/time stamp:                 <span class="m">1292775379</span> <span class="o">(</span>Sun, <span class="m">19</span> Dec <span class="m">2010</span> 16:16:19 UTC<span class="o">)</span>
</span></span></code></pre></div><ol start="3">
<li><em>Are there any indications that either of these files is packed or obfuscated? If so, what are these indicators?</em></li>
</ol>
<p>The output of <code>strings</code> on both the files does not include <code>LoadLibrary</code> or <code>GetProcAddress</code>. We can have confirmation that these are not packed by using <a href="https://github.com/horsicq/Detect-It-Easy" target="_blank" rel="noopener">Detect It Easy</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ diec Lab01-01.dll
</span></span><span class="line"><span class="cl">PE: compiler: Microsoft Visual C/C++<span class="o">(</span>6.0<span class="o">)[</span>msvcrt<span class="o">]</span>
</span></span><span class="line"><span class="cl">PE: linker: Microsoft Linker<span class="o">(</span>6.0<span class="o">)[</span>DLL32<span class="o">]</span>
</span></span><span class="line"><span class="cl">$ diec Lab01-01.exe
</span></span><span class="line"><span class="cl">PE: compiler: Microsoft Visual C/C++<span class="o">(</span>6.0<span class="o">)[</span>msvcrt<span class="o">]</span>
</span></span><span class="line"><span class="cl">PE: linker: Microsoft Linker<span class="o">(</span>6.0<span class="o">)[</span>DLL32<span class="o">]</span>
</span></span></code></pre></div><p>If the given file is packed, the <code>diec</code> command would list the packer used in the output.</p>
<ol start="4">
<li><em>Do any imports hint at what this malware does? If so, which imports are they?</em></li>
</ol>
<p><code>pev</code> allows us to check the imported functions by using the <code>-i</code> flag, for instance:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ readpe -i Lab01-01.dll
</span></span><span class="line"><span class="cl">Imported functions
</span></span><span class="line"><span class="cl">    Library
</span></span><span class="line"><span class="cl">        Name:                            KERNEL32.dll
</span></span><span class="line"><span class="cl">        Functions
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Hint:                            <span class="m">662</span>
</span></span><span class="line"><span class="cl">                Name:                            Sleep
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Hint:                            <span class="m">68</span>
</span></span><span class="line"><span class="cl">                Name:                            CreateProcessA
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Hint:                            <span class="m">63</span>
</span></span><span class="line"><span class="cl">                Name:                            CreateMutexA
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Hint:                            <span class="m">493</span>
</span></span><span class="line"><span class="cl">                Name:                            OpenMutexA
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Hint:                            <span class="m">27</span>
</span></span><span class="line"><span class="cl">                Name:                            CloseHandle
</span></span><span class="line"><span class="cl">    Library
</span></span><span class="line"><span class="cl">        Name:                            WS2_32.dll
</span></span><span class="line"><span class="cl">        Functions
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Ordinal:                         <span class="m">23</span>
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Ordinal:                         <span class="m">115</span>
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Ordinal:                         <span class="m">11</span>
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Ordinal:                         <span class="m">4</span>
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Ordinal:                         <span class="m">19</span>
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Ordinal:                         <span class="m">22</span>
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Ordinal:                         <span class="m">16</span>
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Ordinal:                         <span class="m">3</span>
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Ordinal:                         <span class="m">116</span>
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Ordinal:                         <span class="m">9</span>
</span></span><span class="line"><span class="cl">    Library
</span></span><span class="line"><span class="cl">        Name:                            MSVCRT.dll
</span></span><span class="line"><span class="cl">        Functions
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Hint:                            <span class="m">157</span>
</span></span><span class="line"><span class="cl">                Name:                            _adjust_fdiv
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Hint:                            <span class="m">657</span>
</span></span><span class="line"><span class="cl">                Name:                            malloc
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Hint:                            <span class="m">271</span>
</span></span><span class="line"><span class="cl">                Name:                            _initterm
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Hint:                            <span class="m">606</span>
</span></span><span class="line"><span class="cl">                Name:                            free
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Hint:                            <span class="m">704</span>
</span></span><span class="line"><span class="cl">                Name:                            strncmp
</span></span></code></pre></div><p>In order to make the blog post more readable, I&rsquo;ll summarize the findings and list only the interesting functions.</p>
<ul>
<li>Lab01–01.exe imports functions from <code>KERNEL32.dll</code> and <code>MSVCRT.dll</code></li>
<li>Lab01–01.dll imports functions from <code>KERNEL32.dll</code>, <code>MSVCRT.dll</code>, and <code>WS2_32.dll</code></li>
</ul>
<p><code>KERNEL32.dll</code> contains important functionalities (like access and edit memory and files), thus is a common DLL to import. It is interesting to note the presence of <code>FindFirstFileA</code> and <code>FindNextFileA</code> in Lab01–01.exe, and <code>CreateProcessA</code> in Lab01–01.dll.</p>
<p><code>WS2_32.dll</code> is used for network functionalities, but in this case is imported by ordinals, thus we don&rsquo;t have many additional information.</p>
<ol start="5">
<li><em>Are there any other files or host-based indicators that you could look for on infected systems?</em></li>
</ol>
<p>Using <code>strings</code> on Lab01-01.exe file, we can see some interesting findings, such as:</p>
<ul>
<li><code>kerne132.dll</code></li>
<li><code>kernel32.dll</code></li>
<li><code>C:\windows\system32\kerne132.dll</code></li>
<li><code>Kernel32.</code></li>
<li><code>Lab01-01.dll</code></li>
<li><code>C:\Windows\System32\Kernel32.dll</code></li>
<li><code>WARNING_THIS_WILL_DESTROY_YOUR_MACHINE</code> (my favorite)</li>
</ul>
<p>In particular, we can assume the existence of the file named <code>kerne132.dll</code> (with a <em>1</em> instead of an <em>l</em>) for infected machines.</p>
<ol start="6">
<li><em>What network-based indicators could be used to find this malware on infected machines?</em></li>
</ol>
<p>Using <code>strings</code> on Lab01-01.dll, we can see an IP address: <code>127.26.152.13</code>.</p>
<ol start="7">
<li><em>What would you guess is the purpose of these files?</em></li>
</ol>
<p>Other interesting results running <code>strings</code> are: <code>exec</code>, <code>hello</code>, <code>CreateProcess</code> and <code>sleep</code>; which are names of functions. Based on the findings provided, we can say that these two files may be used to create a backdoor.</p>
<h2 id="lab-1-2">Lab 1-2<a hidden class="anchor" aria-hidden="true" href="#lab-1-2">#</a></h2>
<ol>
<li><em>Upload the Lab01-02.exe file to VirusTotal. Does it match any existing antivirus definitions?</em></li>
</ol>
<p>The file is considered malicious by 55 engines, <a href="https://www.virustotal.com/gui/file/c876a332d7dd8da331cb8eee7ab7bf32752834d4b2b54eaa362674a2a48f64a6/detection" target="_blank" rel="noopener">here is the report</a>.</p>
<ol start="2">
<li><em>Are there any indications that this file is packed or obfuscated? If so, what are these indicators? If the file is packed, unpack it if possible.</em></li>
</ol>
<p>Detect It Easy finds that UPX has been used in this case:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ diec Lab01-02.exe
</span></span><span class="line"><span class="cl">PE: packer: UPX<span class="o">(</span>3.04<span class="o">)[</span>NRV,best<span class="o">]</span>
</span></span><span class="line"><span class="cl">PE: compiler: Microsoft Visual C/C++<span class="o">(</span>6.0<span class="o">)[</span>-<span class="o">]</span>
</span></span><span class="line"><span class="cl">PE: linker: Microsoft Linker<span class="o">(</span>6.0<span class="o">)[</span>EXE32,console<span class="o">]</span>
</span></span></code></pre></div><p>We can then proceed to unpack the file with the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ upx -d -o Lab01-02_unpacked.exe Lab01-02.exe
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                       Ultimate Packer <span class="k">for</span> eXecutables
</span></span><span class="line"><span class="cl">                          Copyright <span class="o">(</span>C<span class="o">)</span> <span class="m">1996</span> - <span class="m">2020</span>
</span></span><span class="line"><span class="cl">UPX git-d7ba31+ Markus Oberhumer, Laszlo Molnar <span class="p">&amp;</span> John Reiser   Jan 23rd <span class="m">2020</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        File size         Ratio      Format      Name
</span></span><span class="line"><span class="cl">   --------------------   ------   -----------   -----------
</span></span><span class="line"><span class="cl">     <span class="m">16384</span> &lt;-      <span class="m">3072</span>   18.75%    win32/pe     Lab01-02_unpacked.exe
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Unpacked <span class="m">1</span> file.
</span></span></code></pre></div><ol start="3">
<li><em>Do any imports hint at this program’s functionality? If so, which imports are they and what do they tell you?</em></li>
</ol>
<p>As shown in the previous exercise, we can use <code>readpe -i</code> to check the imported functions. Here are the interesting findings:</p>
<ul>
<li><code>KERNEL32.DLL</code>: <code>SystemTimeToFileTime</code>, <code>GetModuleFileNameA</code>, <code>CreateMutexA</code>, <code>CreateThread</code> and <code>SetWaitableTimer</code></li>
<li><code>ADVAPI32.DLL</code>: <code>CreateServiceA</code>, <code>StartServiceCtrlDispatcherA</code> and <code>OpenSCManagerA</code></li>
<li><code>WININET.DLL</code>: <code>InternetOpenUrlA</code> and <code>InternetOpenA</code></li>
</ul>
<p>In particular, the last DLL file suggests that the file is communicating over the Internet.</p>
<ol start="4">
<li><em>What host or network-based indicators could be used to identify this malware on infected machines?</em></li>
</ol>
<p>Again, <code>strings</code> is our friend: <code>MalService</code>, <code>Malservice</code>, <code>HGL345</code>,<code>http://www.malwareanalysisbook.com</code> and <code>Internet Explorer 8.0</code>. These results are suggesting that the file is creating a service (probably <code>MalService</code>?) and connecting to the URL.</p>
<h2 id="lab-1-3">Lab 1-3<a hidden class="anchor" aria-hidden="true" href="#lab-1-3">#</a></h2>
<ol>
<li><em>Upload the Lab01-03.exe file to VirusTotal. Does it match any existing antivirus definitions?</em></li>
</ol>
<p>Lab01-03.exe is detected as malicious by 64 engines, <a href="https://www.virustotal.com/gui/file/7983a582939924c70e3da2da80fd3352ebc90de7b8c4c427d484ff4f050f0aec/detection" target="_blank" rel="noopener">here is the report</a>.</p>
<ol start="2">
<li><em>Are there any indications that this file is packed or obfuscated? If so, what are these indicators? If the file is packed, unpack it if possible.</em></li>
</ol>
<p>Scanning the file with <code>diec</code> shows that it is packed with FSG 1.0:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ diec Lab01-03.exe
</span></span><span class="line"><span class="cl">PE: packer: FSG<span class="o">(</span>1.0<span class="o">)[</span>-<span class="o">]</span>
</span></span><span class="line"><span class="cl">PE: linker: unknown<span class="o">(</span>0.0<span class="o">)[</span>EXE32,console<span class="o">]</span>
</span></span></code></pre></div><p>Unfortunately it is not possible (AFAIK) to unpack it with <code>upx</code>, thus I cannot proceed:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ upx -d Lab01-03.exe
</span></span><span class="line"><span class="cl">                       Ultimate Packer <span class="k">for</span> eXecutables
</span></span><span class="line"><span class="cl">                          Copyright <span class="o">(</span>C<span class="o">)</span> <span class="m">1996</span> - <span class="m">2020</span>
</span></span><span class="line"><span class="cl">UPX git-d7ba31+ Markus Oberhumer, Laszlo Molnar <span class="p">&amp;</span> John Reiser   Jan 23rd <span class="m">2020</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        File size         Ratio      Format      Name
</span></span><span class="line"><span class="cl">   --------------------   ------   -----------   -----------
</span></span><span class="line"><span class="cl">upx: Lab01-03.exe: NotPackedException: not packed by UPX
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Unpacked <span class="m">0</span> files.
</span></span></code></pre></div><ol start="3">
<li><em>Do any imports hint at this program’s functionality? If so, which imports are they and what do they tell you?</em></li>
</ol>
<p>Being still packed, we have limited visibility on Lab01–03.exe. We can only see that it imports <code>KERNEL32.DLL</code> and uses the following functions: <code>LoadLibraryA</code> and <code>GetProcAddress</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ readpe -i Lab01-03.exe
</span></span><span class="line"><span class="cl">Imported functions
</span></span><span class="line"><span class="cl">    Library
</span></span><span class="line"><span class="cl">        Name:                            KERNEL32.dll
</span></span><span class="line"><span class="cl">        Functions
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Hint:                            <span class="m">0</span>
</span></span><span class="line"><span class="cl">                Name:                            LoadLibraryA
</span></span><span class="line"><span class="cl">            Function
</span></span><span class="line"><span class="cl">                Hint:                            <span class="m">0</span>
</span></span><span class="line"><span class="cl">                Name:                            GetProcAddress
</span></span></code></pre></div><ol start="4">
<li><em>What host or network-based indicators could be used to identify this malware on infected machines?</em></li>
</ol>
<p>In this case, <code>strings</code> does not help us a lot, because the file is packed.
Again we see <code>LoadLibraryA</code> and <code>GetProcAddress</code>. Some of the other strings seems to refer to <a href="https://en.wikipedia.org/wiki/Object_Linking_and_Embedding" target="_blank" rel="noopener">OLE</a>.</p>
<h2 id="lab-1-4">Lab 1-4<a hidden class="anchor" aria-hidden="true" href="#lab-1-4">#</a></h2>
<ol>
<li><em>Upload the Lab01-04.exe file to VirusTotal. Does it match any existing antivirus definitions?</em></li>
</ol>
<p>The file is detected as malicious by 61 engines, <a href="https://www.virustotal.com/gui/file/0fa1498340fca6c562cfa389ad3e93395f44c72fd128d7ba08579a69aaf3b126/detection" target="_blank" rel="noopener">here is the report</a>.</p>
<ol start="2">
<li><em>Are there any indications that this file is packed or obfuscated? If so, what are these indicators? If the file is packed, unpack it if possible.</em></li>
</ol>
<p>The file does not seem to be packed:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ diec Lab01-04.exe
</span></span><span class="line"><span class="cl">PE: compiler: Microsoft Visual C/C++<span class="o">(</span>6.0<span class="o">)[</span>msvcrt<span class="o">]</span>
</span></span><span class="line"><span class="cl">PE: linker: Microsoft Linker<span class="o">(</span>6.0*<span class="o">)[</span>EXE32<span class="o">]</span>
</span></span></code></pre></div><ol start="3">
<li><em>When was this program compiled?</em></li>
</ol>
<p>The time stamp reported seems suspicious 🤔, considering that the book was published in 2012:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ readpe Lab01-04.exe <span class="p">|</span> grep <span class="s2">&#34;time stamp&#34;</span>
</span></span><span class="line"><span class="cl">    Date/time stamp:                 <span class="m">1567204019</span> <span class="o">(</span>Fri, <span class="m">30</span> Aug <span class="m">2019</span> 22:26:59 UTC<span class="o">)</span>
</span></span></code></pre></div><p>It was probably modified, thus it&rsquo;s not clear when the file was actually compiled.</p>
<ol start="4">
<li><em>Do any imports hint at this program’s functionality? If so, which imports are they and what do they tell you?</em></li>
</ol>
<p>Here are the imports found with <code>readpe -i</code>:</p>
<ul>
<li><code>ADVAPI32.dll</code>: <code>AdjustTokenPrivileges</code>, <code>LookupPrivilegeValueA</code> and <code>OpenProcessToken</code>.</li>
<li><code>KERNEL32.dll</code>: <code>CreateRemoteThread</code>, <code>MoveFileA</code>, <code>SizeofResource</code>, <code>LoadResource</code>, <code>GetModuleHandleA</code>, <code>OpenProcess</code>, <code>GetWindowsDirectoryA</code>, <code>WriteFile</code>, <code>GetCurrentProcess</code>, <code> CreateFileA</code>, <code>GetProcAddress</code>, <code>FindResourceA</code>, <code>LoadLibraryA</code> and <code>WinExec</code>.</li>
</ul>
<p>Considering the functions used, we can say that the program will try to access protected files (<code>SizeOfResource</code>, <code>FindResource</code>, <code>LoadResource</code>, <code>LookupPrivilegeValueA</code> and <code>AdjustTokenPrivilages</code>) and create and execute files (<code>CreateFile</code>, <code>WriteFile</code> and <code>WinExec</code>).</p>
<ol start="5">
<li><em>What host or network-based indicators could be used to identify this malware on infected machines?</em></li>
</ol>
<p>Here are the host and network-based indicators that can be found using <code>strings</code>:</p>
<ul>
<li><strong>host-based</strong>: <code>C:\WINDOWS\system32\wupdmgrd.exe</code> and <code>winup.exe</code></li>
<li><strong>network-based</strong>: <code>http://www.practicalmalwareanalysis.com/updater.exe</code></li>
</ul>
<ol start="6">
<li><em>This file has one resource in the resource section. Use Resource Hacker to examine that resource, and then use it to extract the resource. What can you learn from the resource?</em></li>
</ol>
<p>We can list and extract the resources from a Windows binary using <code>wrestool</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ wrestool -l Lab01-04.exe
</span></span><span class="line"><span class="cl">--type<span class="o">=</span><span class="s1">&#39;BIN&#39;</span> --name<span class="o">=</span><span class="m">101</span> --language<span class="o">=</span><span class="m">1033</span> <span class="o">[</span><span class="nv">offset</span><span class="o">=</span>0x4060 <span class="nv">size</span><span class="o">=</span>16384<span class="o">]</span>
</span></span><span class="line"><span class="cl">$ wrestool -x --raw --output<span class="o">=</span>Lab01-04.bin Lab01-04.exe
</span></span></code></pre></div><ul>
<li><a href="https://www.virustotal.com/gui/file/819b2db1876d85846811799664d512b2f1af13e329f5debe60926c3b03424745/detection" target="_blank" rel="noopener">VirusTotal report</a></li>
<li>Not packed:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ diec Lab01-04.bin
</span></span><span class="line"><span class="cl">PE: compiler: Microsoft Visual C/C++<span class="o">(</span>6.0<span class="o">)[</span>msvcrt<span class="o">]</span>
</span></span><span class="line"><span class="cl">PE: linker: Microsoft Linker<span class="o">(</span>6.0<span class="o">)[</span>EXE32<span class="o">]</span>
</span></span></code></pre></div><ul>
<li>Compiled on <code>1298765819 (Sun, 27 Feb 2011 00:16:59 UTC)</code>.</li>
<li>Imports: <code>KERNEl32.dll</code> (<code>WinExec</code>) and <code>urlmon.dll</code> (<code>URLDownloadToFileA</code>)</li>
<li>Interesting strings: <code>\system32\wupdmgr.exe</code>, <code>winup.exe</code> and <code>www.malwareanalysisbok.com/updater.exe</code></li>
</ul>
<p>Considering the information obtained, we can assume that the Lab01-04.exe file will be used to change permissions to write in a directory and drop and execute the hidden resource, which contacts the network to download and run additional malware.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://andpalmier.com/tags/malware/">Malware</a></li>
      <li><a href="https://andpalmier.com/tags/malware-analysis/">Malware-Analysis</a></li>
      <li><a href="https://andpalmier.com/tags/exercises/">Exercises</a></li>
    </ul>
  </footer><script src="https://utteranc.es/client.js"
        repo="andpalmier/andpalmier.github.io"
        issue-term="og:title"
        label="comment"
        theme="preferred-color-scheme"
        crossorigin="anonymous"
        async>
</script>

</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://andpalmier.com/">andpalmier</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a><script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
const images = Array.from(document.querySelectorAll(".post-content img"));
images.forEach(img => {
  mediumZoom(img, {
    margin: 0,  
    scrollOffset: 40,  
    container: null,  
    template: null,  
    background: 'rgba(0, 0, 0, 0.8)'
  });
});
</script>


<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
